<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>MsgCtrl</title>
        <script type="importmap">
            {
                "imports": {
                    "vue": "https://cdn.jsdelivr.net/npm/vue@3.5.13/dist/vue.esm-browser.js",
                    "vue-router": "https://cdn.jsdelivr.net/npm/vue-router@4.5.0/dist/vue-router.esm-browser.prod.js",
                    "@graffiti-garden/implementation-local": "https://cdn.jsdelivr.net/npm/@graffiti-garden/implementation-local@0.6.4/dist/browser/index.js",
                    "@graffiti-garden/implementation-remote": "https://cdn.jsdelivr.net/npm/@graffiti-garden/implementation-remote@0.6.2/dist/browser/index.js",
                    "@graffiti-garden/wrapper-vue": "https://cdn.jsdelivr.net/npm/@graffiti-garden/wrapper-vue@0.7.2/dist/browser/plugin.mjs",
                    "./chat-category.js": "./chat-category.js",
                    "./schema.js": "./schema.js"
                }
            }
        </script>
        <link rel="stylesheet" href="style.css" />
    </head>
    <body>
        <div id="app">
            <header>
                <nav>
                    <button v-if="!$graffitiSession.value" @click="$graffiti.login()">
                        Log In
                    </button>
                    <template v-else>
                        <button @click="$graffiti.logout($graffitiSession.value)">
                                Log Out
                            </button>
                    </template>
                    <button  v-if="$graffitiSession.value" @click="$router.push('/profile/' + removeURLFromUsername($graffitiSession.value.actor))">Profile</button>
                </nav>
                <div class="header-content">
                    <h1><router-link to="/">MsgCtrl</router-link></h1>
                    <p class="slogan">A Mission Control for your messages</p>
                </div>
            </header>

 
            <router-view></router-view>
            <!--
            <div v-if="$graffitiSession.value && profile == removeURLFromUsername($graffitiSession.value.actor) && profileReady && editingProfile">
                <h2>Profile</h2>
                <form @submit.prevent="updateProfile($graffitiSession.value)">
                    <p><label for="username">Username</label>
                    <input type="text" v-model="latestProfile.value.object.username" /></p>

                    <p><label for="name">Name</label>
                    <input type="text" v-model="latestProfile.value.object.name" /></p>

                    <p><label for="email">Email</label>
                    <input type="email" v-model="latestProfile.value.object.email" /></p>

                    <p><label for="picURL">Pic URL</label>
                    <input type="text" v-model="latestProfile.value.object.picURL" /></p>

                    <input type="submit" value="Update" :disabled="!profile || isLoading" />
                </form>
            </div>
            <div v-else-if="profile && profileReady">
                <h2>Profile</h2>
                <p>Username: {{ latestProfile.value.object.username}}</p>
                <p>Name: {{ latestProfile.value.object.name }}</p>
                <p>Email: {{ latestProfile.value.object.email }}</p>
                <img :src="latestProfile.value.object.picURL" />
                <button v-if="!editingProfile && profile == removeURLFromUsername($graffitiSession.value.actor)"  @click="editingProfile = true">Edit</button>
            </div>
            -->

            <div v-if="$graffitiSession.value">
                Hello, {{ removeURLFromUsername($graffitiSession.value.actor) }}
                <button @click="$router.push('/profile/' + removeURLFromUsername($graffitiSession.value.actor))">Profile</button>
                <button @click="$router.push('/')">Home</button>
                <form @submit.prevent="createChannel($graffitiSession.value)">
                    <p> Create Channel
                    <input
                        type="text"
                        v-model="myNewChatName"
                        placeholder="MyChat"
                    />
                    <select v-model="myNewChatCategory">
                        <option value="Critical ‚ö†Ô∏è">Critical ‚ö†Ô∏è</option>
                        <option value="Inbox">Inbox</option>
                        <option value="Ignore üò¥">Ignore üò¥</option>
                        <option value="Handled ü§ñ">Handled ü§ñ</option>
                    </select>
                    <input type="submit" value="Create" :disabled="!myNewChatName || isLoading" />
                </form>
    
                <div v-if="!categoriesLoaded" class="categories-loading">
                    Loading your category preferences...
                </div>
    
                <graffiti-discover
                    v-slot="{ objects: groupChatObjects }"
                    :channels="['designftw-lucas']"
                    :schema="groupChatSchema"
                >
                    <chat-category 
                        :chat-category-name="'Critical ‚ö†Ô∏è'"
                        :group-chat-objects="groupChatObjects.filter(obj => 
                            categoriesLoaded && getChatCategory(obj?.value?.object?.channel) === 'Critical ‚ö†Ô∏è')"
                        :current-chat-object="currentChatObject"
                        @enter-chat="enterChat"
                        @change-category="(chat, category) => changeChatCategory(chat, category)"
                    />
                </graffiti-discover>
                <hr>
                <graffiti-discover
                    v-slot="{ objects: groupChatObjects }"
                    :channels="['designftw-lucas']"
                    :schema="groupChatSchema"
                >
                    <chat-category 
                        :chat-category-name="'Inbox'"
                        :group-chat-objects="groupChatObjects.filter(obj => 
                            categoriesLoaded && getChatCategory(obj?.value?.object?.channel) === 'Inbox')"
                        :current-chat-object="currentChatObject"
                        @enter-chat="enterChat"
                        @change-category="(chat, category) => changeChatCategory(chat, category)"
                    />
                </graffiti-discover>
                <hr>
                <graffiti-discover
                v-slot="{ objects: groupChatObjects }"
                :channels="['designftw-lucas']"
                :schema="groupChatSchema"
                >
                    <chat-category 
                        class="muted-category"
                        :chat-category-name="'Ignore üò¥'"
                        :group-chat-objects="groupChatObjects.filter(obj => 
                            categoriesLoaded && getChatCategory(obj?.value?.object?.channel) === 'Ignore üò¥')"
                        :current-chat-object="currentChatObject"
                        @enter-chat="enterChat"
                        @change-category="(chat, category) => changeChatCategory(chat, category)"
                    />
                </graffiti-discover>
                <hr>
                <graffiti-discover
                v-slot="{ objects: groupChatObjects }"
                :channels="['designftw-lucas']"
                :schema="groupChatSchema"
                >
                    <chat-category 
                        class="muted-category"
                        :chat-category-name="'Handled ü§ñ'"
                        :group-chat-objects="groupChatObjects.filter(obj => 
                            categoriesLoaded && getChatCategory(obj?.value?.object?.channel) === 'Handled ü§ñ')"
                        :current-chat-object="currentChatObject"
                        @enter-chat="enterChat"
                        @change-category="(chat, category) => changeChatCategory(chat, category)"
                    />
                </graffiti-discover>
    
                <section v-if="currentChatObject">
    
                    <h2>Messages</h2>
                    <p>
                        Current Chat: 
                        <span v-if="!renameChat">{{currentChatObject.name}}
                            <button @click="renameChat = true; newChatName = currentChatObject.name">Rename</button>
                        </span>
                        <span v-else>
                            <input type="text" v-model="newChatName" />
                            <button @click="updateChatName()">Update</button>
                        </span>
                    </p>
                    <form @submit.prevent="sendMessage($graffitiSession.value)">
                        <input
                            type="text"
                            v-model="myMessage"
                            placeholder="Message"
                        />
                        <input type="submit" value="Send" :disabled="!myMessage || isLoading" />
                    </form>
        
    
                    <graffiti-discover
                        v-slot="{ objects: messageObjects }"
                        :channels="[currentChatObject.channel]"
                        :schema="{
                            properties: {
                                value: {
                                    required: ['content', 'published'],
                                    properties: {
                                        content: {
                                            type: 'string'
                                        },
                                        published: {
                                            type: 'number'
                                        }
                                    }
                                }
                            }
                        }"
                    >
                        <button @click="exitChat()">Exit Chat</button>
                        <ul>
                            <li v-for="message in messageObjects" :key="message.value.published">
                                <div class="message-content">
                                    <span v-if="currentlyEditingMessage === message">
                                        <input type="text" v-model="message.value.content" />
                                        <button @click="editMessage(message)">Update</button>
                                    </span>
                                    <span v-else>
                                        <button @click="$router.push('/profile/' + removeURLFromUsername(message.value.actor))">{{ message.value.actor }}</button> - {{ message.value.content }}
                                        <details>
                                            <summary>...</summary>
                                            <button @click="currentlyEditingMessage = message">Edit</button>
                                            <button @click="deleteMessage(message)">Delete</button>
                                        </details>
                                    </span>
                                </div>
                            </li>
                        </ul>
                    </graffiti-discover>
                </section>
    
                <div v-if="isLoading">
                    <img src="img/loader.svg" class="loader" alt="Loading" />
                </div>
            </div>
        </div> 
        <script src="index.js" type="module"></script>
    </body>
</html>
